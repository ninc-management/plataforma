<form (ngSubmit)="createOrUpdate()" #form="ngForm" aria-labelledby="title">
  <nb-tabset fullWidth>
    <nb-tab tabTitle="Dados" tabIcon="info-outline" responsive>
      <div class="row">
        <div
          [ngClass]="{
            'col-md-5': editing,
            'col-md-6': !editing,
            'col-12': true
          }"
        >
          <div class="form-control-group">
            <label class="label" for="input-name">Nome do time:</label>
            <input
              nbInput
              autofocus
              [(ngModel)]="team.name"
              #name="ngModel"
              id="input-name"
              name="name"
              placeholder="Escolha o nome do time"
              fullWidth
              fieldSize="large"
              [required]="validation.name.required"
              [minlength]="validation.name.minLength"
              [maxlength]="validation.name.maxLength"
              [status]="name.touched ? (name.invalid ? 'danger' : 'success') : editing ? 'success' : 'basic'"
              [attr.aria-invalid]="name.invalid && name.touched ? true : null"
            />
          </div>
          <ng-container *ngIf="name.invalid && name.touched">
            <p class="caption status-danger" *ngIf="name.errors?.required">O nome do time é obrigatório!</p>
            <p class="caption status-danger" *ngIf="name.errors?.minlength || name.errors?.maxlength">
              O nome do time deve conter entre {{ validation.name.minLength }} a
              {{ validation.name.maxLength }} caracteres
            </p>
          </ng-container>
        </div>
        <div
          [ngClass]="{
            'col-md-3': editing,
            'col-md-6': !editing,
            'col-12': true
          }"
        >
          <div class="form-control-group">
            <label class="label" for="input-name">Abreviação:</label>
            <input
              nbInput
              autofocus
              [(ngModel)]="team.abrev"
              #abrev="ngModel"
              id="input-abrev"
              name="abrev"
              placeholder="Digite a abreviação do time"
              fullWidth
              fieldSize="large"
              [required]="validation.abrev.required"
              [minlength]="validation.abrev.minLength"
              [maxlength]="validation.abrev.maxLength"
              [status]="abrev.touched ? (abrev.invalid ? 'danger' : 'success') : editing ? 'success' : 'basic'"
              [attr.aria-invalid]="abrev.invalid && abrev.touched ? true : null"
              (focusout)="team.config.path = editing ? team.config.path : team.abrev"
            />
          </div>
          <ng-container *ngIf="abrev.invalid && abrev.touched">
            <p class="caption status-danger" *ngIf="abrev.errors?.required">O nome do time é obrigatório!</p>
            <p class="caption status-danger" *ngIf="abrev.errors?.minlength || abrev.errors?.maxlength">
              O nome do time deve conter entre {{ validation.abrev.minLength }} a
              {{ validation.abrev.maxLength }} caracteres
            </p>
          </ng-container>
        </div>
        <div *ngIf="editing" class="col-12 col-md-4">
          <div class="form-control-group">
            <label class="label" for="input-leader">
              Líder:
              <nb-icon
                status="info"
                icon="info"
                pack="eva"
                [options]="{ animation: { type: 'pulse' } }"
                nbTooltip="A lista de líder é preenchida com a lista de membros. O líder deve fazer parte do time."
                nbTooltipPlacement="top"
                nbTooltipStatus="info"
              ></nb-icon>
            </label>
            <nb-completer
              [(ngModel)]="leaderSearch"
              (selected)="this.team.leader = $event"
              inputName="leaderListCompleter"
              #leaderList="ngModel"
              id="input-leader"
              name="leaderList"
              placeholder="Digite o nome do líder dentro os membros do time"
              textNoResults="
          Não foi possível achar um associado com o nome digitado
          "
              fieldSize="large"
              nameField="fullName"
              pictureField="profilePicture"
              [data$]="availableLeaders"
              [minSearchLength]="0"
              [fullWidth]="true"
              [status]="
                leaderList.touched
                  ? leaderList.invalid
                    ? 'danger'
                    : 'success'
                  : editing && leaderSearch !== ''
                  ? 'success'
                  : 'basic'
              "
              [attr.aria-invalid]="leaderList.invalid && leaderList.touched ? true : null"
            ></nb-completer>
            <ng-container *ngIf="leaderList.invalid && leaderList.touched">
              <p class="caption status-danger" *ngIf="leaderList.errors?.required">
                A escolha do líder do time é obrigatória!
              </p>
            </ng-container>
          </div>
        </div>
        <div class="col-12 col-md-12">
          <div class="form-control-group">
            <label class="label" for="input-purpose">Propósito do time:</label>
            <textarea
              nbInput
              [(ngModel)]="team.purpose"
              #purpose="ngModel"
              id="input-purpose"
              name="purpose"
              placeholder="Insira o propósito do time"
              fullWidth
              fieldSize="large"
              [required]="validation.purpose.required"
              [minlength]="validation.purpose.minLength"
              [maxlength]="validation.purpose.maxLength"
              [status]="
                purpose.touched
                  ? purpose.invalid
                    ? 'danger'
                    : 'success'
                  : editing && team.purpose
                  ? 'success'
                  : 'basic'
              "
              [attr.aria-invalid]="purpose.invalid && purpose.touched ? true : null"
            ></textarea>
            <ng-container *ngIf="purpose.invalid && purpose.touched">
              <p class="caption status-danger" *ngIf="purpose.errors?.required">O propósito do time é obrigatório!</p>
              <p class="caption status-danger" *ngIf="purpose.errors?.minlength || purpose.errors?.maxlength">
                O propósito do time deve conter entre {{ validation.purpose.minLength }} a
                {{ validation.purpose.maxLength }} caracteres
              </p>
            </ng-container>
          </div>
        </div>
        <div class="col-12">
          <div class="form-control-group">
            <label class="label" for="input-expertise">Áreas de atuação:</label>
            <ul>
              <li *ngFor="let sector of SECTORS">
                {{ [sector] | transformPipe: teamService.idToSector.bind(teamService):'abrev' }} -
                {{ [sector] | transformPipe: teamService.idToSector.bind(teamService):'name' }}
              </li>
            </ul>
          </div>
        </div>
        <div class="row irow" *ngIf="!editing">
          <div class="col-12 col-md-7">
            <div class="form-control-group">
              <label class="label" for="input-sector-name">Setor:</label>
              <input
                nbInput
                [(ngModel)]="options.sectorName"
                #sectorNameInput="ngModel"
                id="input-sector-name"
                name="sector-name"
                placeholder="Nome do setor"
                fullWidth
                fieldSize="large"
                [minlength]="validation.sectorName.minLength"
                [maxlength]="validation.sectorName.maxLength"
                [status]="sectorNameInput.invalid ? 'danger' : sectorNameInput.value ? 'success' : 'basic'"
                [attr.aria-invalid]="sectorNameInput.invalid && sectorNameInput.dirty ? true : null"
              />
            </div>
            <ng-container *ngIf="sectorNameInput.invalid && sectorNameInput.touched">
              <p
                class="caption status-danger"
                *ngIf="sectorNameInput.errors?.minlength || sectorNameInput.errors?.maxlength"
              >
                O nome do setor deve conter entre {{ validation.name.minLength }} a
                {{ validation.name.maxLength }} caracteres
              </p>
            </ng-container>
          </div>
          <div class="col-10 col-md-4">
            <div class="form-control-group">
              <label class="label" for="input-sector-abrev">Abreviação:</label>
              <input
                nbInput
                [(ngModel)]="options.sectorAbrev"
                #sectorAbrevInput="ngModel"
                id="input-sector-abrev"
                name="sector-abrev"
                placeholder="Abreviação"
                fullWidth
                fieldSize="large"
                [minlength]="validation.sectorAbrev.minLength"
                [maxlength]="validation.sectorAbrev.maxLength"
                [status]="sectorAbrevInput.invalid ? 'danger' : sectorAbrevInput.value ? 'success' : 'basic'"
                [attr.aria-invalid]="sectorAbrevInput.invalid && sectorAbrevInput.dirty ? true : null"
              />
            </div>
            <ng-container *ngIf="sectorAbrevInput.invalid && sectorAbrevInput.touched">
              <p
                class="caption status-danger"
                *ngIf="sectorAbrevInput.errors?.minlength || sectorAbrevInput.errors?.maxlength"
              >
                A abreviação do setor deve conter entre {{ validation.abrev.minLength }} a
                {{ validation.abrev.maxLength }} caracteres
              </p>
            </ng-container>
          </div>

          <div class="col-2 col-md-1">
            <div class="form-control-group">
              <button
                nbButton
                type="button"
                fullWidth
                status="primary"
                size="large"
                style="margin-top: 28px"
                [disabled]="
                  !options.sectorAbrev || sectorAbrevInput.invalid || !options.sectorName || sectorNameInput.invalid
                "
                (click)="addSector()"
              >
                <nb-icon status="basic" icon="plus" pack="eva"></nb-icon>
              </button>
            </div>
          </div>
          <nb-list style="width: 100%; padding: 10px 0">
            <nb-list-item *ngFor="let sector of team.sectors; let i = index; trackBy: trackByIndex">
              <div class="row typeRow">
                <div class="col-12 col-md-7">
                  <input
                    nbInput
                    [(ngModel)]="sector.name"
                    id="input-sector-name-{{ i }}"
                    name="sector-name-{{ i }}"
                    placeholder="Nome do setor"
                    fullWidth
                    [status]="team.sectors[i].name.length == 0 ? 'danger' : 'basic'"
                  />
                </div>
                <div class="col-10 col-md-4">
                  <input
                    nbInput
                    [(ngModel)]="sector.abrev"
                    id="input-sector-abrev-{{ i }}"
                    name="sector-abrev-{{ i }}"
                    placeholder="Abreviação do setor"
                    fullWidth
                    [status]="team.sectors[i].abrev.length == 0 ? 'danger' : 'basic'"
                  />
                </div>
                <div class="col-2 col-md-1" style="text-align: right">
                  <nb-icon
                    class="xIcon"
                    status="basic"
                    icon="trash-2-outline"
                    pack="eva"
                    (click)="team.sectors.splice(i, 1)"
                    [options]="{ animation: { type: 'shake' } }"
                  ></nb-icon>
                </div>
              </div>
            </nb-list-item>
          </nb-list>
        </div>
        <div class="row irow" *ngIf="editing">
          <div class="col-12 col-md-6">
            <div class="form-control-group">
              <label class="label" for="input-member">Membro disponível:</label>
              <nb-completer
                [(ngModel)]="memberSearch"
                [inputName]="'memberListCompleter'"
                (selected)="currentMember.user = $event; updateUserSectors()"
                #memberList="ngModel"
                id="input-member"
                name="memberList"
                nameField="fullName"
                pictureField="profilePicture"
                [data$]="availableUsers"
                [minSearchLength]="0"
                [placeholder]="'Digite e selecione o nome do membro do time'"
                [textNoResults]="'Não foi possível achar um membro com o nome digitado'"
                [fullWidth]="true"
                [fieldSize]="'large'"
                [status]="memberList.dirty && memberSearch ? (memberList.invalid ? 'danger' : 'success') : 'basic'"
                [attr.aria-invalid]="memberList.invalid && memberList.touched ? true : null"
              ></nb-completer>
            </div>
          </div>
          <div class="col-12 col-md-5">
            <div class="form-control-group">
              <label class="label" for="input-member-sector">
                Setor:
                <nb-icon
                  status="info"
                  icon="info"
                  pack="eva"
                  [options]="{ animation: { type: 'pulse' } }"
                  nbTooltip="Para adicionar um associado, ele deve atuar em algum setor. Esta alteração é feita no perfil do associado."
                  nbTooltipPlacement="top"
                  nbTooltipStatus="info"
                ></nb-icon>
              </label>

              <nb-select
                [(ngModel)]="currentMember.sector"
                #memberSector="ngModel"
                id="input-member-sector"
                name="member-sector"
                placeholder="Setor"
                fullWidth
                size="large"
                [status]="memberSector.value?.length > 0 ? 'success' : 'basic'"
                [attr.aria-invalid]="memberSector.invalid && memberSector.touched ? true : null"
              >
                <nb-option *ngFor="let sector of USER_SECTORS" [value]="sector">
                  {{ sector.abrev }} - {{ sector.name }}
                </nb-option>
              </nb-select>
            </div>
          </div>
          <div class="col-12 col-md-1">
            <div class="form-control-group">
              <button
                nbButton
                type="button"
                fullWidth
                status="primary"
                size="large"
                style="margin-top: 28px"
                [disabled]="!memberList.value || !memberSector.value || currentMember.user === undefined"
                (click)="addMember()"
              >
                <nb-icon status="basic" icon="plus" pack="eva"></nb-icon>
              </button>
            </div>
          </div>
        </div>
        <nb-list style="width: 100%; padding: 10px 0">
          <nb-list-item *ngFor="let member of team.members; let i = index; trackBy: trackByIndex">
            <div class="row irow">
              <div class="col-5 col-md-6">
                <nb-user
                  size="giant"
                  [name]="
                    [member.user, userService.idToUser.bind(userService), 'fullName'] | transformPipe: idToProperty
                  "
                  [picture]="
                    [member.user, userService.idToUser.bind(userService), 'profilePicture']
                      | transformPipe: idToProperty
                  "
                ></nb-user>
              </div>
              <div class="col-5 col-md-5">
                {{ [member.sector] | transformPipe: teamService.idToSector.bind(teamService):'abrev' }} -
                {{ [member.sector] | transformPipe: teamService.idToSector.bind(teamService):'name' }}
              </div>
            </div>
            <div class="col-2 col-md-1" style="text-align: right">
              <nb-icon
                class="xIcon"
                status="basic"
                icon="trash-2-outline"
                pack="eva"
                (click)="handleLeader(i); team.members.splice(i, 1); memberChanged$.next(true); isFormDirty.next(true)"
                [options]="{ animation: { type: 'shake' } }"
              ></nb-icon>
            </div>
          </nb-list-item>
        </nb-list>
      </div>
    </nb-tab>
    <nb-tab *ngIf="editing" tabTitle="Configuração" tabIcon="settings-outline" responsive>
      <div class="row">
        <div class="col-auto">
          <label class="label-divider">Onedrive</label>
        </div>
        <div class="col">
          <hr />
        </div>
      </div>
      <div class="row">
        <div class="col-12">
          <div class="form-control-group">
            <label class="label" for="input-config-path">Path da pasta do time:</label>
            <input
              nbInput
              [(ngModel)]="team.config.path"
              #configPath="ngModel"
              id="input-config-path"
              name="config-path"
              placeholder="Path da pasta do time (ex.: 01-NPJ)"
              fullWidth
              fieldSize="large"
              [required]="validation.path"
              [status]="configPath.value ? 'success' : 'basic'"
              [attr.aria-invalid]="configPath.invalid && configPath.touched ? true : null"
            />
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-auto">
          <label class="label-divider">Porcentagens da organização e nota fiscal</label>
        </div>
        <div class="col">
          <hr />
        </div>
        <div class="col-auto">
          <nb-toggle [(ngModel)]="team.overridePercentages" name="toggle-hide" labelPosition="start">Alterar</nb-toggle>
        </div>
      </div>
      <ng-container *ngIf="team.overridePercentages">
        <div class="row">
          <div class="col-12 col-md-6">
            <div class="form-control-group">
              <label class="label" for="input-org-percentage">Porcentagem da organização:</label>
              <input
                nbInput
                [(ngModel)]="team.organizationPercentage"
                #orgPercentage="ngModel"
                id="input-org-percentage"
                name="orgPercentage"
                placeholder="Porcentagem"
                fullWidth
                fieldSize="large"
                [brmasker]="{
                  money: true,
                  thousand: '.',
                  decimalCaracter: ',',
                  decimal: 2
                }"
                ngxSelectAllText
                [status]="orgPercentage.dirty ? (orgPercentage.invalid ? 'danger' : 'success') : 'basic'"
                [attr.aria-invalid]="orgPercentage.invalid && orgPercentage.touched ? true : null"
              />
            </div>
          </div>
          <div class="col-12 col-md-6">
            <div class="form-control-group">
              <label class="label" for="input-nf-percentage">Porcentagem da nota fiscal:</label>
              <input
                nbInput
                [(ngModel)]="team.nfPercentage"
                #nfPercentage="ngModel"
                id="input-nf-percentage"
                name="nfPercentage"
                placeholder="Porcentagem"
                fullWidth
                fieldSize="large"
                [brmasker]="{
                  money: true,
                  thousand: '.',
                  decimalCaracter: ',',
                  decimal: 2
                }"
                ngxSelectAllText
                [status]="nfPercentage.dirty ? (nfPercentage.invalid ? 'danger' : 'success') : 'basic'"
                [attr.aria-invalid]="nfPercentage.invalid && nfPercentage.touched ? true : null"
              />
            </div>
          </div>
        </div>
      </ng-container>
      <div class="row">
        <div class="col-auto">
          <label class="label-divider">Lista de setores</label>
        </div>
        <div class="col">
          <hr />
        </div>
      </div>
      <div class="row">
        <div class="col-12 col-md-7">
          <div class="form-control-group">
            <label class="label" for="input-sector-name">Setor:</label>
            <input
              nbInput
              [(ngModel)]="options.sectorName"
              #sectorNameInput="ngModel"
              id="input-sector-name"
              name="sector-name"
              placeholder="Nome do setor"
              fullWidth
              fieldSize="large"
              [minlength]="validation.sectorName.minLength"
              [maxlength]="validation.sectorName.maxLength"
              [status]="sectorNameInput.invalid ? 'danger' : sectorNameInput.value ? 'success' : 'basic'"
              [attr.aria-invalid]="sectorNameInput.invalid && sectorNameInput.dirty ? true : null"
            />
          </div>
          <ng-container *ngIf="sectorNameInput.invalid && sectorNameInput.touched">
            <p
              class="caption status-danger"
              *ngIf="sectorNameInput.errors?.minlength || sectorNameInput.errors?.maxlength"
            >
              O nome do setor deve conter entre {{ validation.name.minLength }} a
              {{ validation.name.maxLength }} caracteres
            </p>
          </ng-container>
        </div>
        <div class="col-10 col-md-4">
          <div class="form-control-group">
            <label class="label" for="input-sector-abrev">Abreviação:</label>
            <input
              nbInput
              [(ngModel)]="options.sectorAbrev"
              #sectorAbrevInput="ngModel"
              id="input-sector-abrev"
              name="sector-abrev"
              placeholder="Abreviação"
              fullWidth
              fieldSize="large"
              [minlength]="validation.sectorAbrev.minLength"
              [maxlength]="validation.sectorAbrev.maxLength"
              [status]="sectorAbrevInput.invalid ? 'danger' : sectorAbrevInput.value ? 'success' : 'basic'"
              [attr.aria-invalid]="sectorAbrevInput.invalid && sectorAbrevInput.dirty ? true : null"
            />
          </div>
          <ng-container *ngIf="sectorAbrevInput.invalid && sectorAbrevInput.touched">
            <p
              class="caption status-danger"
              *ngIf="sectorAbrevInput.errors?.minlength || sectorAbrevInput.errors?.maxlength"
            >
              A abreviação do setor deve conter entre {{ validation.abrev.minLength }} a
              {{ validation.abrev.maxLength }} caracteres
            </p>
          </ng-container>
        </div>
        <div class="col-2 col-md-1">
          <button
            nbButton
            type="button"
            fullWidth
            status="primary"
            size="large"
            style="margin-top: 28px"
            [disabled]="
              !options.sectorAbrev || sectorAbrevInput.invalid || !options.sectorName || sectorNameInput.invalid
            "
            (click)="addSector()"
          >
            <nb-icon status="basic" icon="plus" pack="eva"></nb-icon>
          </button>
        </div>
      </div>
      <nb-list style="width: 100%; padding: 10px 0">
        <nb-list-item *ngFor="let sector of team.sectors; let i = index; trackBy: trackByIndex">
          <div class="row typeRow">
            <div class="col-12 col-md-7">
              <input
                nbInput
                [(ngModel)]="sector.name"
                id="input-sector-name-{{ i }}"
                name="sector-name-{{ i }}"
                placeholder="Nome do setor"
                fullWidth
                [status]="team.sectors[i].name.length == 0 ? 'danger' : 'basic'"
              />
            </div>
            <div class="col-10 col-md-4">
              <input
                nbInput
                [(ngModel)]="sector.abrev"
                id="input-sector-abrev-{{ i }}"
                name="sector-abrev-{{ i }}"
                placeholder="Abreviação do setor"
                fullWidth
                [status]="team.sectors[i].abrev.length == 0 ? 'danger' : 'basic'"
              />
            </div>
            <div class="col-2 col-md-1" style="text-align: right">
              <nb-icon
                class="xIcon"
                status="basic"
                icon="trash-2-outline"
                pack="eva"
                (click)="team.sectors.splice(i, 1); isFormDirty.next(true)"
                [options]="{ animation: { type: 'shake' } }"
              ></nb-icon>
            </div>
          </div>
        </nb-list-item>
      </nb-list>
    </nb-tab>
  </nb-tabset>
  <button nbButton fullWidth status="primary" size="large" [disabled]="!form.valid || team.sectors.length == 0">
    {{ editing ? 'Atualizar' : 'Adicionar' }}
  </button>
</form>
