<nb-tabset fullWidth>
  <nb-tab [tabTitle]="utils.isPhone() ? '' : 'Dados'" tabIcon="info-outline" responsive>
    <ngx-data-tab [iContract]="contract"></ngx-data-tab>
  </nb-tab>
  <nb-tab [tabTitle]="utils.isPhone() ? '' : 'Gestão'" responsive>
    <ngx-management-tab [iContract]="contract" [isDialogBlocked]="isDialogBlocked"></ngx-management-tab>
  </nb-tab>
  <nb-tab [tabTitle]="utils.isPhone() ? '' : 'Balanço'" [tabIcon]="scaleIcon" responsive>
    <div class="row">
      <div class="col-auto">
        <label class="label-divider">Geral</label>
      </div>
      <div class="col">
        <hr />
      </div>
    </div>
    <div class="row" style="text-align: center">
      <div class="col-6 col-md">
        <div class="form-control-group">
          <label class="label" for="input-nf">NF(%)</label>
          <p>
            <b>{{ options.notaFiscal }}</b>
          </p>
        </div>
      </div>
      <div class="col-6 col-md">
        <div class="form-control-group">
          <label class="label" for="input-nortan">Nortan(%)</label>
          <p>
            <b>{{ options.nortanPercentage }}</b>
          </p>
        </div>
      </div>
      <div class="col-md">
        <div class="form-control-group">
          <label class="label" for="input-liquid">Bruto a receber</label>
          <p>
            <b>
              {{
                [stringUtil.removePercentage(contract.value, contract.ISS), contract]
                  | transformPipe: contractService.subtractComissions.bind(contractService)
              }}
            </b>
          </p>
        </div>
      </div>
      <div class="col-md">
        <div class="form-control-group">
          <label class="label" for="input-liquid">Líquido a receber</label>
          <p>
            <b>{{ contract.liquid }}</b>
          </p>
        </div>
      </div>
      <div class="col-md">
        <div class="form-control-group">
          <label class="label" for="input-liquid">Comissão</label>
          <p>
            <b>{{ comissionSum }}</b>
          </p>
        </div>
      </div>
      <div class="col-md">
        <div class="form-control-group">
          <label class="label" for="input-liquid">Cashback</label>
          <p>
            <b>{{ contract.cashback }}</b>
          </p>
        </div>
      </div>
      <div class="col-md">
        <div class="form-control-group">
          <label class="label" for="input-value">Saldo do contrato</label>
          <p>
            <b>{{ contract.notPaid }}</b>
          </p>
        </div>
      </div>
    </div>
    <nb-list style="width: 100%; padding: 10px 0; text-align: center">
      <nb-list-item class="noPadding">
        <div class="row irow">
          <div class="col-12 d-flex">
            <div class="col-md-3"><b>Colaborador</b></div>
            <div class="col-md-5 d-flex">
              <div class="col-md-3"><b>Bruto</b></div>
              <div class="col-md-3"><b>Líquido</b></div>
              <div class="col-md-3"><b>%</b></div>
              <div class="col-md-3"><b>Recebido</b></div>
            </div>
            <div class="col-md-4 d-flex">
              <div class="col-md-3"><b>Saldo</b></div>
              <div class="col-md-3"><b>Cashback</b></div>
              <div class="col-md-3"><b>Despesas</b></div>
              <div class="col-md-3"><b>Balanço</b></div>
            </div>
          </div>
        </div>
      </nb-list-item>
      <nb-list-item *ngFor="let member of invoice.team; let i = index; trackBy: utils.trackByIndex" class="noPadding">
        <div class="row irow">
          <div class="col-md-12 d-flex">
            <div class="col-md-3">
              {{
                [member.user, userService.idToUser.bind(userService), 'fullName'] | transformPipe: utils.idToProperty
              }}
            </div>
            <div class="col-md-5 d-flex">
              <div class="col-md-3">
                {{
                  [
                    contractService.netValueBalance(member.distribution, contract, member.user),
                    options.notaFiscal,
                    options.nortanPercentage
                  ] | transformPipe: contractService.toGrossValue.bind(contractService)
                }}
              </div>
              <div class="col-md-3">
                {{
                  [member.distribution, contract, member.user]
                    | transformPipe: contractService.netValueBalance.bind(contractService)
                }}
              </div>
              <div class="col-md-3">
                {{
                  [member.distribution, member.user, contract]
                    | transformPipe: contractService.percentageToReceive.bind(contractService)
                }}
              </div>
              <div class="col-md-3">
                {{ [member.user, contract] | transformPipe: contractService.receivedValue.bind(contractService) }}
              </div>
            </div>
            <div class="col-md-4 d-flex">
              <div class="col-md-3">
                {{
                  [member.distribution, member.user, contract]
                    | transformPipe: contractService.notPaidValue.bind(contractService)
                }}
              </div>
              <div class="col-md-3">
                {{
                  [contractService.expensesContributions(contract, member.user).user.cashback]
                    | transformPipe: stringUtil.numberToMoney.bind(stringUtil)
                }}
              </div>
              <div class="col-md-3">
                {{
                  [member.user, contract] | transformPipe: contractService.getMemberExpensesSum.bind(contractService)
                }}
              </div>
              <div class="col-md-3">
                {{ [member.user, contract] | transformPipe: contractService.getMemberBalance.bind(contractService) }}
              </div>
            </div>
          </div>
        </div>
      </nb-list-item>
    </nb-list>
    <div class="row" style="text-align: center">
      <div class="col-md">
        <div class="form-control-group">
          <label class="label" for="input-balance">Caixa:</label>
          <p
            [ngClass]="{
              success: contract.balance[0] != '-',
              danger: contract.balance[0] == '-'
            }"
          >
            {{ contract.balance }}
          </p>
        </div>
      </div>
      <div class="col-md">
        <div class="form-control-group">
          <label class="label" for="input-paid">Valor pago:</label>
          <p>{{ options.paid }}</p>
        </div>
      </div>
      <div class="col-md">
        <div class="form-control-group">
          <label class="label" for="input-paid">Despesas:</label>
          <p>{{ expenseSourceSum().reverse()[1].value }}</p>
        </div>
      </div>
      <div class="col-md">
        <div class="form-control-group">
          <label class="label" for="input-interest">Parcelas criadas:</label>
          <p>{{ options.interest }}</p>
        </div>
      </div>
      <div class="col-md">
        <div class="form-control-group">
          <label class="label" for="input-total">Parcelas totais:</label>
          <p>{{ contract.total }}</p>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-auto">
        <label class="label-divider">Despesas</label>
      </div>
      <div class="col">
        <hr />
      </div>
    </div>
    <nb-tabset fullWidth>
      <nb-tab
        tabId="contract-tab"
        [tabTitle]="utils.isPhone() ? '' : 'Contrato'"
        [tabIcon]="{
          icon: 'file-invoice',
          pack: 'fac'
        }"
        responsive
      >
        <div class="row" style="text-align: center">
          <div class="col-md-6">
            <div class="form-control-group">
              <nb-list style="width: 100%; padding: 10px 0; text-align: center">
                <nb-list-item
                  *ngFor="
                    let expense of this.contractService.expenseTypesSum(false, contract);
                    let i = index;
                    trackBy: utils.trackByIndex
                  "
                >
                  <div class="row irow">
                    <div class="col-md-6">
                      <b>{{ expense.type }}</b>
                    </div>
                    <div class="col-md-6">{{ expense.value }}</div>
                  </div>
                </nb-list-item>
              </nb-list>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-control-group">
              <nb-list style="width: 100%; padding: 10px 0; text-align: center">
                <nb-list-item *ngFor="let expense of expenseSourceSum(); let i = index; trackBy: utils.trackByIndex">
                  <div class="row irow">
                    <div class="col-md-6">
                      <b>{{ expense.user }}</b>
                    </div>
                    <div class="col-md-6">{{ expense.value }}</div>
                  </div>
                </nb-list-item>
              </nb-list>
            </div>
          </div>
        </div>
      </nb-tab>
      <nb-tab [tabTitle]="utils.isPhone() ? '' : 'Cliente'" [tabIcon]="contractorIcon" responsive>
        <div class="row" style="text-align: center">
          <div class="col-12" style="text-align: center">
            <div class="form-control-group">
              <nb-list style="width: 100%; padding: 10px 0; text-align: center">
                <nb-list-item
                  *ngFor="
                    let expense of contractService.expenseTypesSum(true, contract);
                    let i = index;
                    trackBy: utils.trackByIndex
                  "
                >
                  <div class="row irow">
                    <div class="col-md-6">
                      <b>{{ expense.type }}</b>
                    </div>
                    <div class="col-md-6">{{ expense.value }}</div>
                  </div>
                </nb-list-item>
              </nb-list>
            </div>
          </div>
        </div>
      </nb-tab>
      <nb-tab [tabTitle]="utils.isPhone() ? '' : 'Gráfico'" [tabIcon]="chartIcon" responsive>
        <div class="row" style="text-align: center">
          <div class="col-12">
            <ngx-echarts-bar [contractId]="contractId"></ngx-echarts-bar>
          </div>
        </div>
      </nb-tab>
    </nb-tabset>
  </nb-tab>
  <nb-tab [tabTitle]="utils.isPhone() ? '' : 'Ordens de empenho'" [tabIcon]="receiptIcon" responsive>
    <nb-list>
      <nb-list-item *ngFor="let receipt of contract.receipts; let i = index">
        <div class="row irow" style="width: 100%">
          <div class="col-10 col-md-11">
            <div class="irow row">
              <a (click)="paymentDialog(types.RECEIPT, i)" style="width: 100%; cursor: pointer; display: flex">
                <div class="col-1">#{{ +i + 1 }}</div>
                <div class="col">{{ receipt.description }}</div>
                <div class="col-md-3">
                  <nb-icon icon="dollar-sign" pack="fa" status="success"></nb-icon>
                  <span style="vertical-align: 0.1em">{{ receipt.value }}</span>
                </div>
              </a>
            </div>
          </div>
          <div class="col-2 col-md-1" style="text-align: right">
            <span
              class="mr-1"
              [nbTooltip]="receipt.paid ? 'Pago' : 'Não pago'"
              nbTooltipPlacement="top"
              nbTooltipStatus="info"
            >
              {{ receipt.paid ? '✅' : '❌' }}
            </span>
            <nb-icon
              *ngIf="isEditionGranted"
              class="xIcon"
              status="basic"
              icon="trash-2-outline"
              pack="eva"
              (click)="confirmationDialog(i, types.RECEIPT)"
              [options]="{ animation: { type: 'shake' } }"
            ></nb-icon>
          </div>
        </div>
      </nb-list-item>
    </nb-list>
    <button
      nbButton
      fullWidth
      status="primary"
      size="large"
      [disabled]="contract.receipts.length == +contract.total || !isEditionGranted"
      (click)="paymentDialog(types.RECEIPT)"
    >
      Nova Ordem de Empenho
    </button>
  </nb-tab>
  <nb-tab [tabTitle]="utils.isPhone() ? '' : 'Ordens de pagamento'" [tabIcon]="paymentIcon" responsive>
    <nb-list>
      <nb-list-item *ngFor="let payment of contract.payments; let i = index">
        <div class="row irow" style="width: 100%">
          <div class="col-10 col-md-11">
            <div class="irow row">
              <a (click)="paymentDialog(types.PAYMENT, i)" style="width: 100%; cursor: pointer; display: flex">
                <div class="col-1">#{{ +i + 1 }}</div>
                <div class="col">{{ payment.service }}</div>
                <div class="col-md-3">
                  <nb-icon icon="dollar-sign" pack="fa" status="success"></nb-icon>
                  <span style="vertical-align: 0.1em">{{ payment.value }}</span>
                </div>
              </a>
            </div>
          </div>
          <div class="col-2 col-md-1" style="text-align: right">
            <span
              class="mr-1"
              [nbTooltip]="payment.paid ? 'Pago' : 'Não pago'"
              nbTooltipPlacement="top"
              nbTooltipStatus="info"
            >
              {{ payment.paid ? '✅' : '❌' }}
            </span>
            <nb-icon
              *ngIf="isEditionGranted"
              class="xIcon"
              status="basic"
              icon="trash-2-outline"
              pack="eva"
              (click)="confirmationDialog(i, types.PAYMENT)"
              [options]="{ animation: { type: 'shake' } }"
            ></nb-icon>
          </div>
        </div>
      </nb-list-item>
    </nb-list>
    <button
      nbButton
      fullWidth
      status="primary"
      size="large"
      [disabled]="!isEditionGranted"
      (click)="paymentDialog(types.PAYMENT)"
    >
      Nova Ordem de Pagamento
    </button>
  </nb-tab>
  <nb-tab [tabTitle]="utils.isPhone() ? '' : 'Despesas'" [tabIcon]="expenseIcon" responsive>
    <ng2-smart-table
      #smartTable
      *ngIf="!utils.isPhone(); else phone"
      [settings]="settings"
      [source]="source"
      (create)="paymentDialog(types.EXPENSE)"
      (edit)="paymentDialog(types.EXPENSE, expenseIndex($event.data.code))"
      (delete)="confirmationDialog(expenseIndex($event.data.code), types.EXPENSE)"
    ></ng2-smart-table>
    <ng-template #phone>
      <div class="row">
        <div class="col-2" style="padding-left: 0; padding-right: 0">
          <button
            nbButton
            fullWidth
            status="primary"
            style="height: 100%"
            [disabled]="!isEditionGranted"
            (click)="paymentDialog(types.EXPENSE)"
          >
            <i class="nb-plus" style="font-size: 1.5rem"></i>
          </button>
        </div>
        <div class="col-10">
          <input
            nbInput
            [(ngModel)]="searchQuery"
            #search="ngModel"
            id="input-search"
            name="search"
            placeholder="Busque aqui..."
            fullWidth
            fieldSize="large"
          />
        </div>
      </div>
      <nb-list>
        <nb-list-item *ngFor="let expense of filtredExpenses; let i = index">
          <div class="row irow" style="width: 100%">
            <div class="col-10 col-md-11">
              <div class="irow row">
                <a
                  (click)="paymentDialog(types.EXPENSE, i)"
                  style="width: 100%; cursor: pointer; display: flex; align-items: center"
                >
                  <div class="col-auto">
                    <nb-user
                      [onlyPicture]="true"
                      [name]="
                        [expense.author, userService.idToUser.bind(userService), 'fullName']
                          | transformPipe: utils.idToProperty
                      "
                      [picture]="
                        [expense.author, userService.idToUser.bind(userService), 'profilePicture']
                          | transformPipe: utils.idToProperty
                      "
                    ></nb-user>
                  </div>
                  <div class="col-auto">#{{ +i + 1 }}</div>
                  <div class="col">{{ expense.description }}</div>
                  <div class="col-md-auto">
                    <nb-icon icon="dollar-sign" pack="fa" status="success"></nb-icon>
                    <span style="vertical-align: 0.1em">
                      {{ expense.value }}
                    </span>
                  </div>
                  <div class="col-md-auto">
                    <nb-icon icon="calendar-alt" pack="fa" status="primary"></nb-icon>
                    <span style="vertical-align: 0.1em">
                      {{ [expense.created] | transformPipe: utils.formatDate.bind(utils) }}
                    </span>
                  </div>
                </a>
              </div>
            </div>
            <div class="col-2 col-md-auto" style="text-align: right" *ngIf="isEditionGranted">
              <nb-icon
                class="xIcon"
                status="basic"
                icon="trash-2-outline"
                pack="eva"
                (click)="confirmationDialog(i, types.EXPENSE)"
                [options]="{ animation: { type: 'shake' } }"
              ></nb-icon>
            </div>
          </div>
        </nb-list-item>
      </nb-list>
    </ng-template>
  </nb-tab>
</nb-tabset>
